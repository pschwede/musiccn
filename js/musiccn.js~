var playlist = [];
    
    function play(trackid) {
        var track = playlist[playlist.length-1];
        if(trackid){
            for(i=0; i<playlist.length && track.id!=trackid; i++) {
                track = playlist[i];
            }
        }
        $("#jquery_jplayer").setFile(track.url).play();
        $("#song_title").fadeOut('fast', function() {
                $("#song_title").text(track.artist+" - "+track.title).fadeIn('fast')
        });
        $("#album_cover_box").fadeOut('fast',function() {
                $("#album_cover_box").html('<img src="'+track.cover+'" alt="" />').fadeIn('slow');
        });
    }
    
    function autorequest() {
        $.getJSON(
                "ajax.php?genre=<?php echo $_SESSION['genre']; ?>",
                function(json) {
                    if(json) {
                        playlist.push(json);
                        play();
                    } else {
                        setTimeout("autorequest()", 300);
                    }
                }
                );
    }
    
    function pushTrack() {
        if(playlist.length) {
            var track = playlist[playlist.length-1];
            $('#playlist').prepend(
                '<div style="display:none; background-image:url('+track.cover+
                ')" id="'+track.id+'" class="track stripe">'+
                '<div class="title">'+
                track.artist+" - "+track.title+
                '<a href="javascript:play('+track.id+');'+
                'hide('+track.id+');">(>)</a><a href="'+track.via+'" target="_blank">(w)</a></div></div>'
                );
            $('#playlist > .track:first').slideDown('slow');
            if(playlist.length>15) {
                $('#playlist > .track:last').slideUp('slow', function() {
                        $(this).remove();
                });
                playlist.shift();
            }
        }
    }
    
    $("document").ready(function() {
            
        <?php if(isset($alert)) {?>
        setTimeout('$("div.alert").hide("slow")', 5000);
        $("div.alert").click(function() {
            $("div.alert").hide("slow");
        });
        <?php } ?>
        
        $("ul.sf-menu").superfish();
        
        $("#jquery_jplayer").jPlayer({
            cssPrefix: "jplayer",
            <?php if($_GET['radio']){?>
            volume: 50,
            ready:  function() {
                pushTrack();
                autorequest();
            },
            <?php } else { ?>
            volume: 0,
            <?php } ?>
        });
        <?php if($_GET['radio']) {?>
        $("#jquery_jplayer").jPlayerId("play", "player_play")
        //$("#jquery_jplayer").jPlayerId("pause", "player_pause")
        $("#jquery_jplayer").jPlayerId("stop", "player_stop")
        $("#player_next").click(function() {
            pushTrack();
            autorequest();
        });
        $("#jquery_jplayer").jPlayerId("volumeMin", "player_volume_min")
        $("#jquery_jplayer").jPlayerId("volumeMax", "player_volume_max")
        $("#jquery_jplayer").jPlayerId("volumeBar", "player_volume_bar")
        $("#jquery_jplayer").jPlayerId("volumeBarValue", "player_volume_bar_value")
        $("#jquery_jplayer").onProgressChange( function(lp,ppr,ppa,pt,tt) {
            s = lp<100?"loading "+lp+"%"+" ":'';
            
            var myTotalTime = new Date(tt-pt);
            var ttMin = (myTotalTime.getUTCMinutes() < 10) ? "0" + myTotalTime.getUTCMinutes() : myTotalTime.getUTCMinutes();
            var ttSec = (myTotalTime.getUTCSeconds() < 10) ? "0" + myTotalTime.getUTCSeconds() : myTotalTime.getUTCSeconds();
            $("#total_time").text(s+ttMin+":"+ttSec);
        });
        $("#jquery_jplayer").onSoundComplete( function() {
            pushTrack();
            autorequest();
        });
        <?php } ?>
    });
